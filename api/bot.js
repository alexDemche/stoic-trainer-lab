import { Telegraf, Markup } from 'telegraf';

const token = process.env.BOT_TOKEN;
const bot = new Telegraf(token);

// –¢–≤–æ—î –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ Web App
const webAppLink = "https://breath-flow-app.vercel.app";

// --- –¢–ï–ö–°–¢–ò ---
const mainMenuText = "<b>–í—ñ—Ç–∞—é —É Breath Flow!</b> üëã\n\n–û–±–µ—Ä–∏ –¥—ñ—é, —â–æ–± –ø–æ—á–∞—Ç–∏ –ø—Ä–∞–∫—Ç–∏–∫—É:";

// --- –†–û–ó–ì–û–†–ù–£–¢–ò–ô –¢–ï–ö–°–¢ HELP ---
const helpText = `
<b>üßò –ü—Ä–æ –º–µ—Ç–æ–¥ –ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –¥–∏—Ö–∞–Ω–Ω—è (Box Breathing)</b>

–¶—è —Ç–µ—Ö–Ω—ñ–∫–∞ ‚Äî —Å–µ–∫—Ä–µ—Ç–Ω–∞ –∑–±—Ä–æ—è –µ–ª—ñ—Ç–Ω–∏—Ö –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Navy SEALs) —Ç–∞ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏—Ö –∞—Ç–ª–µ—Ç—ñ–≤ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–ø–æ–∫–æ—é –≤ –µ–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∏—Ö —É–º–æ–≤–∞—Ö.

<b>‚è± –†–∏—Ç–º 4-4-4-4 ‚Äî —Ü–µ:</b>
1. <b>–í–¥–∏—Ö (4 —Å–µ–∫)</b> ‚Äî –ù–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –∫—Ä–æ–≤—ñ –∫–∏—Å–Ω–µ–º.
2. <b>–ó–∞—Ç—Ä–∏–º–∫–∞ (4 —Å–µ–∫)</b> ‚Äî –°—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ—è —Ç–∏—Å–∫—É.
3. <b>–í–∏–¥–∏—Ö (4 —Å–µ–∫)</b> ‚Äî –°–∏–≥–Ω–∞–ª –º–æ–∑–∫—É –Ω–∞ —Ä–æ–∑—Å–ª–∞–±–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –±–ª—É–∫–∞—é—á–∏–π –Ω–µ—Ä–≤.
4. <b>–ó–∞—Ç—Ä–∏–º–∫–∞ (4 —Å–µ–∫)</b> ‚Äî –¢–æ—á–∫–∞ –≥–ª–∏–±–æ–∫–æ–≥–æ –º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–ø–æ–∫–æ—é.

<b>üíé –©–æ —Ü–µ –¥–∞—î?</b>
‚Ä¢ –ú–∏—Ç—Ç—î–≤–µ –∑–Ω–∏–∂–µ–Ω–Ω—è —Ä—ñ–≤–Ω—è –∫–æ—Ä—Ç–∏–∑–æ–ª—É (–≥–æ—Ä–º–æ–Ω—É —Å—Ç—Ä–µ—Å—É).
‚Ä¢ –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è —Ñ–æ–∫—É—Å—É –ø—Ä–∏ "—Ä–æ–∑—É–º–æ–≤–æ–º—É —Ö–∞–æ—Å—ñ".
‚Ä¢ –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è —Å–Ω—É —Ç–∞ –µ–º–æ—Ü—ñ–π–Ω–æ—ó —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ.

<b>üöÄ –Ø–∫ –ø–æ—á–∞—Ç–∏?</b>
–ü—Ä–æ—Å—Ç–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å <b>¬´–ü–æ—á–∞—Ç–∏ –¥–∏—Ö–∞—Ç–∏¬ª</b>, –æ–±–µ—Ä—ñ—Ç—å —á–∞—Å —Å–µ—Å—ñ—ó —Ç–∞ –ø–æ—Ç—ñ–∫, —è–∫–∏–π –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –≤–∞—à–æ–º—É –∑–∞–ø–∏—Ç—É (–õ—é–±–æ–≤, –ì—Ä–æ—à—ñ, –ï–Ω–µ—Ä–≥—ñ—è —á–∏ –°–ø–æ–∫—ñ–π).
`;

// --- –ö–õ–ê–í–Ü–ê–¢–£–†–ò ---

// –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é (–∫–Ω–æ–ø–∫–∏ –Ω–∞–¥ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–æ—é)
const mainKeyboard = Markup.keyboard([
  [Markup.button.webApp('üßò –ü–æ—á–∞—Ç–∏ –¥–∏—Ö–∞—Ç–∏', webAppLink)], // –ì–æ–ª–æ–≤–Ω–∞ –∫–Ω–æ–ø–∫–∞
  ['üìñ –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?', 'üí¨ –ê–≤—Ç–æ—Ä']
]).resize().persistent(); // persistent() —Ç—Ä–∏–º–∞—î –º–µ–Ω—é –≤—ñ–¥–∫—Ä–∏—Ç–∏–º –∑–∞–≤–∂–¥–∏

// –ö–Ω–æ–ø–∫–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
const backKeyboard = Markup.keyboard([
  ['üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é']
]).resize().persistent();

// --- –õ–û–ì–Ü–ö–ê –ë–û–¢–ê ---

// –ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è —Ç–∞ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é
bot.start((ctx) => {
  return ctx.replyWithHTML(mainMenuText, mainKeyboard);
});

// –†–æ–∑–≥–æ—Ä–Ω—É—Ç–∞ –¥–æ–ø–æ–º–æ–≥–∞ –∑ –∫–Ω–æ–ø–∫–æ—é "–ù–∞–∑–∞–¥"
bot.hears('üìñ –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?', (ctx) => {
  return ctx.replyWithHTML(helpText, backKeyboard);
});

// –ó–≤'—è–∑–æ–∫ –∑ –∞–≤—Ç–æ—Ä–æ–º –∑ –∫–Ω–æ–ø–∫–æ—é "–ù–∞–∑–∞–¥"
bot.hears('üí¨ –ê–≤—Ç–æ—Ä', (ctx) => {
  return ctx.replyWithHTML(
    "–ó —É—Å—ñ—Ö –ø–∏—Ç–∞–Ω—å —Ç–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ–π –ø–∏—à—ñ—Ç—å: @erick_demche", 
    backKeyboard
  );
});

// –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é
bot.hears('üîô –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é', (ctx) => {
  return ctx.replyWithHTML(mainMenuText, mainKeyboard);
});

// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ /help
bot.help((ctx) => ctx.replyWithHTML(helpText, backKeyboard));

export default async function handler(req, res) {
  try {
    if (req.method === 'POST') {
      await bot.handleUpdate(req.body);
      return res.status(200).json({ status: 'ok' });
    }
    return res.status(200).send('–ë–æ—Ç Breath Flow –ø—Ä–∞—Ü—é—î!');
  } catch (err) {
    console.error('–ü–æ–º–∏–ª–∫–∞:', err);
    return res.status(200).json({ error: err.message });
  }
}