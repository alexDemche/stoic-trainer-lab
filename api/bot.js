import { Telegraf, Markup } from 'telegraf';

const token = process.env.BOT_TOKEN;
const bot = new Telegraf(token);

const webAppLink = "https://breath-flow-app.vercel.app";

// --- –†–û–ó–ì–û–†–ù–£–¢–ò–ô –¢–ï–ö–°–¢ HELP ---
const helpMessage = `
<b>üßò –ü—Ä–æ –º–µ—Ç–æ–¥ –ö–≤–∞–¥—Ä–∞—Ç–Ω–æ–≥–æ –¥–∏—Ö–∞–Ω–Ω—è (Box Breathing)</b>

–¶—è —Ç–µ—Ö–Ω—ñ–∫–∞ ‚Äî —Å–µ–∫—Ä–µ—Ç–Ω–∞ –∑–±—Ä–æ—è –µ–ª—ñ—Ç–Ω–∏—Ö –ø—ñ–¥—Ä–æ–∑–¥—ñ–ª—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, Navy SEALs) —Ç–∞ –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏—Ö –∞—Ç–ª–µ—Ç—ñ–≤ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–ø–æ–∫–æ—é –≤ –µ–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∏—Ö —É–º–æ–≤–∞—Ö.

<b>‚è± –†–∏—Ç–º 4-4-4-4 ‚Äî —Ü–µ:</b>
1. <b>–í–¥–∏—Ö (4 —Å–µ–∫)</b> ‚Äî –ù–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –∫—Ä–æ–≤—ñ –∫–∏—Å–Ω–µ–º.
2. <b>–ó–∞—Ç—Ä–∏–º–∫–∞ (4 —Å–µ–∫)</b> ‚Äî –°—Ç–∞–±—ñ–ª—ñ–∑–∞—Ü—ñ—è —Ç–∏—Å–∫—É.
3. <b>–í–∏–¥–∏—Ö (4 —Å–µ–∫)</b> ‚Äî –°–∏–≥–Ω–∞–ª –º–æ–∑–∫—É –Ω–∞ —Ä–æ–∑—Å–ª–∞–±–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –±–ª—É–∫–∞—é—á–∏–π –Ω–µ—Ä–≤.
4. <b>–ó–∞—Ç—Ä–∏–º–∫–∞ (4 —Å–µ–∫)</b> ‚Äî –¢–æ—á–∫–∞ –≥–ª–∏–±–æ–∫–æ–≥–æ –º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–ø–æ–∫–æ—é.

<b>üíé –©–æ —Ü–µ –¥–∞—î?</b>
‚Ä¢ –ú–∏—Ç—Ç—î–≤–µ –∑–Ω–∏–∂–µ–Ω–Ω—è —Ä—ñ–≤–Ω—è –∫–æ—Ä—Ç–∏–∑–æ–ª—É (–≥–æ—Ä–º–æ–Ω—É —Å—Ç—Ä–µ—Å—É).
‚Ä¢ –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è —Ñ–æ–∫—É—Å—É –ø—Ä–∏ "—Ä–æ–∑—É–º–æ–≤–æ–º—É —Ö–∞–æ—Å—ñ".
‚Ä¢ –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è —Å–Ω—É —Ç–∞ –µ–º–æ—Ü—ñ–π–Ω–æ—ó —Å—Ç–∞–±—ñ–ª—å–Ω–æ—Å—Ç—ñ.

<b>üöÄ –Ø–∫ –ø–æ—á–∞—Ç–∏?</b>
–ü—Ä–æ—Å—Ç–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å <b>¬´–ü–æ—á–∞—Ç–∏ –¥–∏—Ö–∞—Ç–∏¬ª</b>, –æ–±–µ—Ä—ñ—Ç—å —á–∞—Å —Å–µ—Å—ñ—ó —Ç–∞ –ø–æ—Ç—ñ–∫, —è–∫–∏–π –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –≤–∞—à–æ–º—É –∑–∞–ø–∏—Ç—É (–õ—é–±–æ–≤, –ì—Ä–æ—à—ñ, –ï–Ω–µ—Ä–≥—ñ—è —á–∏ –°–ø–æ–∫—ñ–π).
`;

// --- –ì–û–õ–û–í–ù–ï –ú–ï–ù–Æ (/start) ---
bot.start((ctx) => {
  const name = ctx.from.first_name || '–î—Ä—É–∂–µ';
  
  return ctx.replyWithHTML(
    `–í—ñ—Ç–∞—é, ${name}! üëã\n\n–¶–µ —Ç–≤—ñ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä –¥–ª—è <b>Breath Flow</b>. –¢—É—Ç —Ç–∏ –º–æ–∂–µ—à –∑–∞ –ª—ñ—á–µ–Ω—ñ —Ö–≤–∏–ª–∏–Ω–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ —Å–≤–æ—î –¥–∏—Ö–∞–Ω–Ω—è —Ç–∞ –∑–º—ñ–Ω–∏—Ç–∏ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Å—Ç–∞–Ω.\n\n–û–±–µ—Ä–∏ –¥—ñ—é –Ω–∏–∂—á–µ:`,
    Markup.keyboard([
      [Markup.button.webApp('üßò –ü–æ—á–∞—Ç–∏ –¥–∏—Ö–∞—Ç–∏', webAppLink)],
      ['üìñ –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?', 'üí¨ –ó–≤‚Äô—è–∑–æ–∫ –∑ –∞–≤—Ç–æ—Ä–æ–º']
    ]).resize() // resize —Ä–æ–±–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –∞–∫—É—Ä–∞—Ç–Ω–∏–º–∏ –∑–∞ —Ä–æ–∑–º—ñ—Ä–æ–º
  );
});

// –û–±—Ä–æ–±–∫–∞ —Ç–µ–∫—Å—Ç—É –∑ –∫–Ω–æ–ø–æ–∫ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
bot.hears('üìñ –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î?', (ctx) => ctx.replyWithHTML(helpMessage));
bot.hears('üí¨ –ó–≤‚Äô—è–∑–æ–∫ –∑ –∞–≤—Ç–æ—Ä–æ–º', (ctx) => ctx.reply('–ó —É—Å—ñ—Ö –ø–∏—Ç–∞–Ω—å: @oleksii_demchenko'));

bot.help((ctx) => ctx.replyWithHTML(helpMessage));

export default async function handler(req, res) {
  try {
    if (req.method === 'POST') {
      await bot.handleUpdate(req.body);
      return res.status(200).json({ status: 'ok' });
    }
    return res.status(200).send('–ë–µ–∫–µ–Ω–¥ –∑ –ì–æ–ª–æ–≤–Ω–∏–º –ú–µ–Ω—é –∞–∫—Ç–∏–≤–Ω–∏–π!');
  } catch (err) {
    console.error('–ü–æ–º–∏–ª–∫–∞:', err);
    return res.status(200).json({ error: err.message });
  }
}